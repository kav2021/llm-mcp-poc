# ==============================
# MCP-style Temperature Agent
# InfluxDB Cloud v2
# ==============================

# REQUIREMENTS:
# pip install influxdb-client

from influxdb_client import InfluxDBClient, Point
from influxdb_client.client.write_api import SYNCHRONOUS

# ------------------------------
# CONFIGURATION
# ------------------------------
INFLUX_URL = "https://us-east-1-1.aws.cloud2.influxdata.com"
INFLUX_TOKEN = "K3JKc5W5eLB3JWAtnySYHX3ClZ1P6EWvVOCB79i8SQVcrTJPVQivuYVkPZRluGEE79WnPHF9CnbcMaa1XD3jLg=="
INFLUX_ORG = "e78a1cfd926eaf45"
INFLUX_BUCKET = "Factory"

# Measurement & Field (IMPORTANT)
MEASUREMENT = "sensor_temperature"
FIELD = "value"

# ------------------------------
# INFLUX TOOL (MCP TOOL)
# ------------------------------
class InfluxTemperatureTool:
    def __init__(self):
        self.client = InfluxDBClient(
            url=INFLUX_URL,
            token=INFLUX_TOKEN,
            org=INFLUX_ORG
        )
        self.query_api = self.client.query_api()
        self.write_api = self.client.write_api(write_options=SYNCHRONOUS)

    # --------------------------
    # READ: LATEST TEMPERATURE
    # --------------------------
    def get_latest_temperature(self):
        flux = f"""
from(bucket: "{INFLUX_BUCKET}")
  |> range(start: -1h)
  |> filter(fn: (r) => r._measurement == "{MEASUREMENT}")
  |> filter(fn: (r) => r._field == "{FIELD}")
  |> last()
"""
        tables = self.query_api.query(flux)
        for table in tables:
            for record in table.records:
                return record.get_value()
        return None

    # --------------------------
    # READ: MEAN TEMPERATURE (Grafana-style)
    # --------------------------
    def get_mean_temperature_series(self, lookback="-1h", window="1m"):
        """
        Python equivalent of:

        from(bucket: "Factory")
          |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
          |> filter(fn: (r) => r._measurement == "sensor_temperature")
          |> filter(fn: (r) => r._field == "value")
          |> aggregateWindow(every: 1m, fn: mean, createEmpty: false)
          |> map(fn: (r) => ({ r with _field: "Temperature" }))
          |> yield(name: "temperature")
        """
        flux = f"""
from(bucket: "{INFLUX_BUCKET}")
  |> range(start: {lookback})
  |> filter(fn: (r) => r._measurement == "{MEASUREMENT}")
  |> filter(fn: (r) => r._field == "{FIELD}")
  |> aggregateWindow(every: {window}, fn: mean, createEmpty: false)
  |> map(fn: (r) => ({{ r with _field: "Temperature" }}))
  |> yield(name: "temperature")
"""
        return self.query_api.query(flux)

    # --------------------------
    # WRITE: TEMPERATURE
    # --------------------------
    def write_temperature(self, value: float, location: str = "factory"):
        point = (
            Point(MEASUREMENT)
            .field(FIELD, value)
            .tag("location", location)
        )

        self.write_api.write(
            bucket=INFLUX_BUCKET,
            org=INFLUX_ORG,
            record=point
        )

        return f"Temperature {value}Â°C written to bucket '{INFLUX_BUCKET}'"

# ------------------------------
# MCP AGENT (Simple Example)
# ------------------------------
class TemperatureAgent:
    def __init__(self):
        self.tool = InfluxTemperatureTool()

    def handle(self, message: str):
        message = message.lower()

        if "latest" in message or "current" in message:
            value = self.tool.get_latest_temperature()
            return f"ğŸŒ¡ Latest temperature: {value} Â°C"

        if "mean" in message or "average" in message:
            tables = self.tool.get_mean_temperature_series()
            values = []
            for table in tables:
                for record in table.records:
                    values.append(record.get_value())
            return f"ğŸ“Š Mean temperature points: {len(values)}"

        if "write" in message:
            self.tool.write_temperature(25.5)
            return "âœ… Temperature written successfully"

        return "â“ I can read or write temperature data."

# ------------------------------
# RUN (TEST)
# ------------------------------
if __name__ == "__main__":
    agent = TemperatureAgent()

    print(agent.handle("latest temperature"))
    print(agent.handle("mean temperature"))
